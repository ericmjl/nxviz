name: Pull request checks

on: [pull_request]

env:
  cache-version: "cache-v1"

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
    - uses: pre-commit/action@v3.0.1
  build-environment:
    needs: pre-commit
    strategy:
      max-parallel: 10
      matrix:
        environment: [py310, py311, py312]
    runs-on: ubuntu-latest
    name: Build conda environment
    steps:
      - uses: actions/checkout@v4
        name: Checkout repository

      - name: Setup Pixi Environment
        uses: prefix-dev/setup-pixi@v0.8.1
        with:
          environments: ${{ matrix.environment }}
          pixi-version: v0.39.2
          cache: true
          cache-write: ${{ github.event_name == 'push' && github.ref_name == 'main' }}

      - name: Test build, unit tests and docs
        run: |
          pixi run test
          pixi run docs

        # https://www.bradmcgonigle.com/blog/github-action-for-continuous-deployment
      # - NETLIFY_SITE_ID maps to the netlify site's API ID
      # - NETLIFY_AUTH_TOKEN maps to netlify's Personal Access Token that I set on a per-user basis
      - name: Deploy to Netlify
        if: matrix.config.os == 'ubuntu-latest' && matrix.config.python-version == '3.12'
        uses: netlify/actions/cli@master
        with:
          args: deploy --site ${{ secrets.NETLIFY_SITE_ID }} --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} --dir=site/
